
services:
  - type: web
    name: openwebui
    plan: free
    runtime: image
    image:
      url: ghcr.io/open-webui/open-webui:main
    healthCheckPath: /
    startCommand: >
      sh -lc 'echo "RAG_OPENAI_API_BASE_URL=${RAG_OPENAI_API_BASE_URL}"; 
          echo "RAG_OPENAI_BASE_URL=${RAG_OPENAI_BASE_URL}";
          echo "RAG_EMBEDDING_ENGINE=${RAG_EMBEDDING_ENGINE}";
          open-webui serve --host 0.0.0.0 --port ${PORT} --workers 1'
    envVars:
      # ---- Core DB for chats (Render Postgres) ----
      - key: DATABASE_URL
        fromDatabase:
          name: openwebui-db
          property: connectionString

      # ---- First-boot admin (flip later) ----
      - key: ENABLE_SIGNUP
        value: "true"
      - key: DEFAULT_USER_ROLE
        value: admin

      # ---- Ensure env overrides any stale DB config ----
      - key: PERSISTENT_CONFIG
        value: "false"

      # ---- Quiet Ollama probes on Render ----
      - key: ENABLE_OLLAMA
        value: "false"
      - key: OLLAMA_BASE_URL
        value: ""

      # ---- Chat LLM via Groq (OpenAI-compatible) ----
      - key: OPENAI_API_BASE_URL
        value: https://api.groq.com/openai/v1
      - key: OPENAI_API_KEY
        sync: false  # paste your gsk_... in Render UI

      # ---- Vector store: Qdrant Cloud (external) ----
      - key: VECTOR_DB
        value: qdrant
      - key: ENABLE_RAG
        value: "true"
      - key: QDRANT_URI
        value: https://e4989f2e-319c-4f2c-a3a8-8ce0e74fd388.us-east4-0.gcp.cloud.qdrant.io:6333     # e.g. https://...qdrant.io:6333
      - key: QDRANT_URL
        value: https://e4989f2e-319c-4f2c-a3a8-8ce0e74fd388.us-east4-0.gcp.cloud.qdrant.io:6333
      - key: QDRANT_API_KEY
        sync: false

      # ---- Embeddings via OpenAI (not Voyage) ----
      - key: RAG_EMBEDDING_ENGINE
        value: openai
      - key: RAG_OPENAI_API_BASE_URL
        value: https://api.openai.com/v1
      - key: RAG_OPENAI_API_KEY
        sync: false   # paste your sk_... in Render UI
      - key: RAG_EMBEDDING_MODEL
        value: text-embedding-3-small
      - key: RAG_EMBEDDING_BATCH_SIZE
        value: "1"

databases:
  - name: openwebui-db
    plan: free
